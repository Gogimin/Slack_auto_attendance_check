# 🤖 자동 실행 스케줄 가이드

## 🎯 새로 추가된 기능

### ✅ 1. 출석 스레드 자동 생성
- 매주 특정 요일, 특정 시간에 슬랙 채널에 출석 스레드 자동 생성
- 봇이 자동으로 메시지 작성

### ✅ 2. 출석 집계 자동 실행
- 매주 특정 요일, 특정 시간에 출석 자동 집계
- 구글 스프레드시트 자동 업데이트
- 알림 자동 전송

### ✅ 3. 특정 사람에게 알림 전송
- 지정된 담당자에게 출석 결과 DM 자동 전송
- 스레드 작성자 대신 특정 관리자에게 전송 가능

### ✅ 4. 한국 시간대 (KST, UTC+9) 지원
- 모든 스케줄은 한국 시간 기준으로 동작

---

## ⚠️ 중요: 프로그램 실행 필수

**자동 실행 스케줄이 작동하려면 프로그램(Flask 앱)이 계속 실행 중이어야 합니다.**

### 왜 계속 실행해야 하나요?

- 스케줄러는 Flask 앱 내부에서 동작합니다
- 프로그램을 종료하면 스케줄러도 함께 중단됩니다
- **프로그램이 꺼지면 예약된 작업이 실행되지 않습니다**

### 해결 방법

#### **방법 1: 컴퓨터를 항상 켜두기**
- 가장 간단한 방법
- 절전 모드나 최대 절전 모드 비활성화 필요

#### **방법 2: 서버에서 24시간 실행** (추천)
- AWS, Azure, Google Cloud 등 클라우드 서버 사용
- 월 $5-10 정도의 저렴한 서버로도 충분

#### **방법 3: 백그라운드로 실행**
Windows에서 백그라운드 실행:
```bash
# 터미널 창을 닫아도 계속 실행
start /B pythonw app_flask.py
```

#### **방법 4: Windows 서비스로 등록**
- NSSM (Non-Sucking Service Manager) 사용
- 부팅 시 자동 실행 가능

---

## 🚀 사용 방법

### 1단계: APScheduler 설치

먼저 터미널에서 패키지를 설치하세요:

```bash
conda activate auto
pip install APScheduler==3.10.4
```

또는

```bash
conda activate auto
pip install -r requirements.txt
```

---

### 2단계: 웹 UI에서 스케줄 설정

#### 1. 프로그램 실행
```
실행.bat 더블클릭
```

#### 2. 워크스페이스 선택
- 드롭다운에서 워크스페이스 선택

#### 3. 스케줄 설정 섹션으로 이동
- **"⏰ 자동 실행 스케줄 (선택사항)"** 섹션 찾기
- **"자동 실행 활성화"** 체크박스 클릭

#### 4. 출석 스레드 자동 생성 설정
- **요일**: 예) 토요일
- **시간**: 예) 09:00 (오전 9시)
- **스레드 메시지**:
  ```
  📢 출석 스레드

  오늘 출석 체크합니다!
  이 메시지에 '이름/출석' 형식으로 댓글 달아주세요.
  ```

#### 5. 출석 집계 자동 실행 설정
- **요일**: 예) 토요일
- **시간**: 예) 21:00 (오후 9시)
- **출석 열**: 예) K

#### 6. 알림 수신자 설정 (선택)
- **User ID 입력**: 예) `U09L9UWC5L6`
- 비워두면 스레드 작성자에게 전송됩니다.

**User ID 찾는 방법:**
1. 슬랙에서 자신의 프로필 클릭
2. "프로필 보기" 클릭
3. "..." (더보기) → "멤버 ID 복사"
4. `U`로 시작하는 ID가 User ID입니다.

#### 7. 저장
- **"💾 스케줄 저장"** 버튼 클릭
- "스케줄이 저장되었습니다!" 메시지 확인

---

### 3단계: 서버 재시작

**중요**: 스케줄 변경 사항을 적용하려면 서버를 재시작해야 합니다.

1. 터미널에서 `Ctrl+C` 눌러 서버 종료
2. `실행.bat` 다시 실행
3. 콘솔에서 스케줄 등록 확인:
   ```
   📅 스케줄 등록: 테스트
     ✓ 출석 스레드 생성: 매주 sat 09:00
     ✓ 출석 집계: 매주 sat 21:00
   ```

---

## 📋 설정 예시

### 예시 1: 매주 토요일 자동 출석체크

**시나리오:**
- 토요일 오전 9시: 출석 스레드 자동 생성
- 토요일 오후 9시: 출석 자동 집계 및 알림

**설정:**
```
✅ 자동 실행 활성화

📝 출석 스레드 자동 생성
- 요일: 토요일
- 시간: 09:00

📊 출석 집계 자동 실행
- 요일: 토요일
- 시간: 21:00
- 출석 열: K

알림 수신자: U1234567890
```

---

### 예시 2: 여러 워크스페이스 각각 다른 시간

**워크스페이스 A (학교A):**
```
- 출석 스레드 생성: 월요일 08:00
- 출석 집계: 월요일 18:00
```

**워크스페이스 B (학교B):**
```
- 출석 스레드 생성: 화요일 09:00
- 출석 집계: 화요일 20:00
```

각 워크스페이스마다 독립적으로 스케줄 설정 가능!

---

## 🔧 config.json 직접 수정 (고급)

웹 UI 대신 직접 수정하려면:

```json
{
  "name": "테스트",
  "slack_bot_token": "xoxb-...",
  "slack_channel_id": "C...",
  "spreadsheet_id": "1...",
  "sheet_name": "출석현황",
  "name_column": 1,
  "start_row": 4,

  "notification_user_id": "U09L9UWC5L6",

  "auto_schedule": {
    "enabled": true,
    "create_thread_day": "sat",
    "create_thread_time": "09:00",
    "create_thread_message": "📢 출석 스레드\n\n오늘 출석 체크합니다!",
    "check_attendance_day": "sat",
    "check_attendance_time": "21:00",
    "check_attendance_column": "K"
  }
}
```

**요일 코드:**
- `mon` - 월요일
- `tue` - 화요일
- `wed` - 수요일
- `thu` - 목요일
- `fri` - 금요일
- `sat` - 토요일
- `sun` - 일요일

---

## 🎯 동작 과정

### 자동 출석 스레드 생성
```
1. 설정된 시간 도달 (예: 토요일 09:00)
2. 봇이 슬랙 채널에 메시지 자동 작성
3. 학생들이 댓글로 출석 체크
```

### 자동 출석 집계
```
1. 설정된 시간 도달 (예: 토요일 21:00)
2. 최신 "출석 스레드" 메시지 자동 검색
3. 댓글 수집 및 파싱
4. 구글 스프레드시트 자동 업데이트 (O/X)
5. 스레드에 완료 댓글 자동 작성
6. 담당자에게 DM 자동 전송
   - 출석자/미출석자 명단
   - 출석률 통계
```

---

## 🔍 로그 확인

프로그램 실행 중 터미널에서 스케줄 실행 로그를 확인할 수 있습니다:

```
[자동실행] 출석 스레드 생성 시작 - 테스트
시간: 2025-10-15 09:00:00
✓ 출석 스레드 생성 완료: 1234567890.123456

[자동실행] 출석 집계 시작 - 테스트
시간: 2025-10-15 21:00:00
✓ 출석 스레드 발견: 1234567890.123456
✓ 출석자 수: 25명
✓ 구글 시트 업데이트 완료: 30개
✓ 출석 집계 완료!
```

---

## ❓ FAQ

### Q1: 프로그램을 종료하면 자동 실행이 안 되나요?
**A:** 네, **프로그램이 실행 중일 때만** 자동 실행이 작동합니다.
- 프로그램을 종료하면 스케줄도 중단됩니다
- 24시간 자동 실행을 원하면 프로그램을 계속 켜두거나 서버에서 실행하세요

### Q2: 스케줄을 수정했는데 적용이 안 돼요.
**A:** 서버를 재시작해야 합니다.
```
Ctrl+C → 실행.bat 재실행
```

### Q3: 한국 시간이 맞나요?
**A:** 네! 모든 시간은 한국 시간대 (KST, UTC+9) 기준입니다.

### Q4: 여러 워크스페이스를 동시에 자동 실행할 수 있나요?
**A:** 네! 각 워크스페이스별로 독립적인 스케줄 설정 가능합니다.

### Q5: 출석 스레드만 자동 생성하고, 집계는 수동으로 하고 싶어요.
**A:** 출석 스레드 생성 시간만 설정하고, 출석 집계 시간은 비워두세요.

### Q6: 특정 사람에게만 알림 보낼 수 있나요?
**A:** 네! "알림 수신자 User ID"에 특정 사람의 User ID를 입력하세요.

### Q7: EXE 파일로 빌드해도 작동하나요?
**A:** 네! `빌드.bat` 실행 후 EXE 파일에서도 자동 실행이 동일하게 작동합니다.
- 단, **EXE 파일을 실행 중일 때만** 스케줄이 작동합니다

### Q8: 수동 출석체크와 자동 출석체크의 차이는?
**A:**
- **수동 (3️⃣ 섹션)**: 지금 바로 실행 버튼을 눌러서 출석 체크
- **자동 (⏰ 섹션)**: 예약 시간에 자동으로 출석 체크 (프로그램 실행 중일 때)

---

## 🎉 완료!

이제 출석체크가 완전 자동화되었습니다!

- ✅ 토요일 오전 9시: 출석 스레드 자동 생성
- ✅ 학생들이 댓글로 출석
- ✅ 토요일 오후 9시: 자동 집계 + 알림

**프로그램을 백그라운드로 계속 실행하면 됩니다!**

---

**Made with Python & Flask ❤️**
