# 서버 배포 가이드

## 배포 워크플로우

```
로컬 PC (설정) → 서버 (자동 실행)
```

---

## 1️⃣ 로컬 PC에서 스케줄 설정

### 1-1. 프로그램 실행

**방법 A: 배치 파일 실행**
```bash
실행.bat 더블클릭
```

**방법 B: EXE 실행**
```bash
dist\슬랙출석체크\슬랙출석체크.exe 더블클릭
```

### 1-2. 웹 UI 자동 열림

프로그램 실행 후 1.5초 뒤 자동으로 브라우저가 열립니다:
```
http://127.0.0.1:5000
```

### 1-3. 스케줄 설정

1. **⏰ 자동 실행 스케줄** 탭 클릭
2. 워크스페이스 선택 (예: "서울대학교")
3. **출석 스레드 생성 시간** 설정:
   - 요일: `토요일`
   - 시간: `17:00`
   - 메시지: `📢 출석 스레드\n\n오늘 출석 체크합니다!` (커스터마이징 가능)
4. **출석 집계 시간** 설정:
   - 요일: `토요일`
   - 시간: `18:00` (스레드 생성 후 30분~1시간 뒤)
   - 출석 기입 열: `K`
5. **알림 받을 사용자 ID** 입력 (선택사항):
   - 슬랙 User ID (예: `U01ABC123DEF`)
   - 찾는 법: 슬랙 → 프로필 클릭 → "프로필 더보기" → 하단의 "멤버 ID 복사"
6. **"스케줄 저장"** 버튼 클릭

### 1-4. 설정 파일 확인

스케줄이 저장되면 `workspaces/[워크스페이스명]/workspace.json`에 자동으로 저장됩니다:

```json
{
  "display_name": "서울대학교",
  "slack_bot_token": "xoxb-...",
  "slack_channel_id": "C01ABC123",
  "spreadsheet_id": "1A2B3C...",
  "sheet_name": "Sheet1",
  "name_column": "B",
  "start_row": 2,
  "notification_user_id": "U01ABC123",
  "auto_schedule": {
    "enabled": true,
    "create_thread_day": "sat",
    "create_thread_time": "17:00",
    "create_thread_message": "📢 출석 스레드\n\n오늘 출석 체크합니다!",
    "check_attendance_day": "sat",
    "check_attendance_time": "18:00",
    "check_attendance_column": "K"
  }
}
```

### 1-5. 여러 워크스페이스 설정

각 학교/워크스페이스별로 1-3 ~ 1-4 과정을 반복합니다.

### 1-6. 프로그램 종료

```
Ctrl + C
```

---

## 2️⃣ 서버에 배포

### 2-1. 필요한 파일 목록

```
Slack_auto_attendance_check/
├── app_flask.py              ← 메인 서버 파일
├── requirements.txt          ← Python 패키지 목록
├── src/                      ← 소스 코드
│   ├── workspace_manager.py
│   ├── slack_handler.py
│   ├── sheets_handler.py
│   ├── parser.py
│   └── utils.py
├── templates/                ← HTML 템플릿
│   └── index.html
├── static/                   ← CSS/JS 파일
│   ├── css/
│   └── js/
└── workspaces/               ← ⭐ 설정 파일 (중요!)
    ├── 서울대/
    │   ├── workspace.json
    │   └── credentials.json
    ├── 연세대/
    │   ├── workspace.json
    │   └── credentials.json
    └── ...
```

### 2-2. 서버로 파일 전송

**방법 A: SCP 사용 (Linux/Mac)**
```bash
scp -r Slack_auto_attendance_check/ user@server.example.com:/home/user/
```

**방법 B: SFTP 사용 (Windows - FileZilla, WinSCP 등)**
1. SFTP 클라이언트로 서버 접속
2. 전체 프로젝트 폴더 업로드

**방법 C: Git 사용**
```bash
# 로컬
git init
git add .
git commit -m "Initial deployment"
git remote add origin https://github.com/your-repo.git
git push origin main

# 서버
git clone https://github.com/your-repo.git
cd your-repo
```

⚠️ **보안 주의**: Git 사용 시 반드시 `.gitignore`에 추가:
```gitignore
workspaces/*/credentials.json
workspaces/*/workspace.json
.env
*.log
```

### 2-3. 서버 환경 설정

**Python 및 패키지 설치:**
```bash
# Python 3.8 이상 확인
python3 --version

# 가상환경 생성 (선택사항)
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 또는
venv\Scripts\activate     # Windows

# 패키지 설치
pip install -r requirements.txt
```

---

## 3️⃣ 서버 실행

### 3-1. 직접 실행 (테스트용)

```bash
python3 app_flask.py
```

**출력 예시:**
```
==================================================
슬랙 출석체크 관리 시스템 v2.0
==================================================
현재 작업 디렉토리: /home/user/Slack_auto_attendance_check
실행 파일 위치: /home/user/Slack_auto_attendance_check

✓ 모든 폴더 확인 완료

✓ 3개의 워크스페이스를 찾았습니다

==================================================
스케줄러 초기화 중...
==================================================

📅 스케줄 등록: 서울대학교
  ✓ 출석 스레드 생성: 매주 sat 17:00
  ✓ 출석 집계: 매주 sat 18:00

📅 스케줄 등록: 연세대학교
  ✓ 출석 스레드 생성: 매주 sun 19:00
  ✓ 출석 집계: 매주 sun 20:00

✓ 스케줄러 시작 완료 (한국 시간대: Asia/Seoul)

==================================================
서버 시작 중...
==================================================
URL: http://127.0.0.1:5000
종료하려면 Ctrl+C를 누르세요.
==================================================
```

### 3-2. 백그라운드 실행 (프로덕션)

**방법 A: nohup 사용**
```bash
nohup python3 app_flask.py > server.log 2>&1 &
```

**방법 B: screen 사용**
```bash
screen -S attendance
python3 app_flask.py
# Ctrl+A, D로 detach
# 재연결: screen -r attendance
```

**방법 C: tmux 사용**
```bash
tmux new -s attendance
python3 app_flask.py
# Ctrl+B, D로 detach
# 재연결: tmux attach -t attendance
```

**방법 D: systemd 서비스 (추천)**

`/etc/systemd/system/slack-attendance.service` 파일 생성:
```ini
[Unit]
Description=Slack Attendance Checker
After=network.target

[Service]
Type=simple
User=your-username
WorkingDirectory=/home/user/Slack_auto_attendance_check
Environment="PATH=/home/user/Slack_auto_attendance_check/venv/bin"
ExecStart=/home/user/Slack_auto_attendance_check/venv/bin/python3 app_flask.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

서비스 시작:
```bash
sudo systemctl daemon-reload
sudo systemctl enable slack-attendance
sudo systemctl start slack-attendance

# 상태 확인
sudo systemctl status slack-attendance

# 로그 확인
sudo journalctl -u slack-attendance -f
```

---

## 4️⃣ 자동 실행 확인

### 4-1. 스케줄 확인

서버에서 프로그램을 실행하면 스케줄이 자동으로 등록됩니다.

### 4-2. 실행 흐름

```
토요일 17:00 → 슬랙에 출석 스레드 자동 생성
              "📢 출석 스레드\n\n오늘 출석 체크합니다!"

(학생들이 댓글 작성 - 30분~1시간)

토요일 18:00 → 자동으로 댓글 수집
              → 구글 시트에 출석 기입
              → 슬랙 스레드에 완료 댓글
              → 관리자에게 DM 전송
```

### 4-3. 로그 확인

**터미널 출력:**
```
[자동실행] 출석 스레드 생성 시작 - 서울대학교
시간: 2025-10-16 17:00:00
✓ 출석 스레드 생성 완료: 1234567890.123456

[자동실행] 출석 집계 시작 - 서울대학교
시간: 2025-10-16 18:00:00
✓ 출석 스레드 발견: 1234567890.123456
✓ 출석자 수: 45명
✓ 구글 시트 업데이트 완료: 50개
✓ 출석 집계 완료!
```

---

## 5️⃣ 서버 종료

### 5-1. 직접 실행 종료

```bash
Ctrl + C
```

### 5-2. 백그라운드 프로세스 종료

**nohup 사용 시:**
```bash
ps aux | grep app_flask.py
kill [PID]
```

**screen 사용 시:**
```bash
screen -r attendance
Ctrl + C
exit
```

**systemd 사용 시:**
```bash
sudo systemctl stop slack-attendance
```

---

## 6️⃣ 트러블슈팅

### 문제 1: 스케줄이 실행되지 않음

**원인:**
- 서버 시간대가 다름
- 스케줄 설정이 저장되지 않음

**해결:**
```bash
# 서버 시간대 확인
date
timedatectl

# 한국 시간대로 변경 (필요시)
sudo timedatectl set-timezone Asia/Seoul

# workspace.json 확인
cat workspaces/서울대/workspace.json
```

### 문제 2: 스레드가 생성되지 않음

**원인:**
- 슬랙 Bot Token 권한 부족
- 채널에 봇이 추가되지 않음

**해결:**
1. 슬랙 API 페이지에서 `chat:write` 권한 확인
2. 채널에서 `/invite @출석체크봇` 실행

### 문제 3: 구글 시트 업데이트 실패

**원인:**
- credentials.json 파일이 서버에 없음
- 서비스 계정에 스프레드시트 공유 안 됨

**해결:**
1. credentials.json 파일 확인
2. 구글 시트에서 서비스 계정 이메일로 공유 확인

---

## 7️⃣ 보안 체크리스트

- [ ] workspaces/*/credentials.json 파일 권한 설정 (600)
- [ ] workspaces/*/workspace.json 파일 권한 설정 (600)
- [ ] Git 저장소에 민감 정보 커밋하지 않기 (.gitignore 설정)
- [ ] 서버 방화벽 설정 (5000 포트 외부 접근 차단)
- [ ] systemd 서비스 실행 시 일반 사용자 권한 사용 (root 금지)

```bash
# 파일 권한 설정
chmod 600 workspaces/*/credentials.json
chmod 600 workspaces/*/workspace.json
```

---

## 8️⃣ 업데이트 방법

### 설정 변경 시:

```bash
# 로컬 PC에서 웹 UI로 스케줄 재설정
실행.bat → 웹 UI → 스케줄 수정 → 저장

# workspaces/ 폴더만 서버로 재전송
scp -r workspaces/ user@server:/path/to/project/

# 서버에서 재시작
sudo systemctl restart slack-attendance
```

### 코드 업데이트 시:

```bash
# 로컬에서 Git push
git add .
git commit -m "Update code"
git push origin main

# 서버에서 Git pull
git pull origin main

# 서버 재시작
sudo systemctl restart slack-attendance
```

---

## 9️⃣ 모니터링

### 실시간 로그 확인:

```bash
# systemd 사용 시
sudo journalctl -u slack-attendance -f

# nohup 사용 시
tail -f server.log
```

### 스케줄 실행 확인:

```bash
# 출력 로그에서 다음 실행 시간 확인
grep "스케줄 등록" server.log
```

---

완료! 이제 서버가 자동으로 스케줄에 맞춰 출석체크를 진행합니다. 🎉
