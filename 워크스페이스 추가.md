# 워크스페이스 설정 가이드

새로운 학교/워크스페이스를 추가하는 방법을 단계별로 설명합니다.

---

## 1. 슬랙(Slack) 설정

### 1-1. 슬랙 앱 생성

1. **Slack API 페이지 접속**
   - https://api.slack.com/apps 접속
   - "Create New App" 클릭

2. **앱 생성 방식 선택**
   - "From scratch" 선택
   - App Name: `출석체크봇` (원하는 이름)
   - Workspace: 출석체크를 사용할 워크스페이스 선택
   - "Create App" 클릭

### 1-2. Bot Token Scopes 설정

1. **OAuth & Permissions 메뉴로 이동**
   - 왼쪽 메뉴에서 "OAuth & Permissions" 클릭

2. **Scopes 추가**
   - "Scopes" 섹션에서 "Bot Token Scopes" 찾기
   - 다음 권한들을 추가:
     ```
     channels:history    - 채널 메시지 읽기
     channels:read       - 채널 정보 읽기
     chat:write          - 메시지 작성
     users:read          - 사용자 정보 읽기
     im:write            - DM 전송
     ```

### 1-3. 워크스페이스에 앱 설치

1. **앱 설치**
   - "OAuth & Permissions" 페이지 상단
   - "Install to Workspace" 버튼 클릭
   - 권한 확인 후 "허용" 클릭

2. **Bot Token 복사**
   - 설치 완료 후 "Bot User OAuth Token" 표시됨
   - `xoxb-`로 시작하는 토큰 복사
   - **중요**: 이 토큰은 절대 외부에 공개하지 마세요!

### 1-4. 출석체크 채널에 봇 추가

1. **슬랙 워크스페이스에서 채널 선택**
   - 출석체크를 진행할 채널 선택 (예: #출석체크)

2. **봇 멤버로 추가**
   - 채널에서 `/invite @출석체크봇` 입력
   - 또는 채널 설정 → 통합 → 앱 추가

3. **채널 ID 확인**
   - 채널 이름 클릭 → 하단의 "채널 ID" 복사
   - `C`로 시작하는 문자열 (예: `C01ABC123DEF`)

---

## 2. 구글 스프레드시트 설정

### 2-1. Google Cloud 프로젝트 생성

1. **Google Cloud Console 접속**
   - https://console.cloud.google.com/ 접속
   - Google 계정으로 로그인

2. **새 프로젝트 생성**
   - 상단의 프로젝트 선택 드롭다운 클릭
   - "새 프로젝트" 클릭
   - 프로젝트 이름: `출석체크-[학교명]` (예: 출석체크-서울대)
   - "만들기" 클릭

### 2-2. Google Sheets API 활성화

1. **API 라이브러리로 이동**
   - 왼쪽 메뉴 → "API 및 서비스" → "라이브러리"

2. **Google Sheets API 검색 및 활성화**
   - 검색창에 "Google Sheets API" 입력
   - "Google Sheets API" 클릭
   - "사용" 버튼 클릭

### 2-3. 서비스 계정 생성

1. **서비스 계정 메뉴로 이동**
   - 왼쪽 메뉴 → "API 및 서비스" → "사용자 인증 정보"
   - "사용자 인증 정보 만들기" → "서비스 계정" 선택

2. **서비스 계정 정보 입력**
   - 서비스 계정 이름: `출석체크봇` (원하는 이름)
   - 서비스 계정 ID: 자동 생성됨
   - 설명: `출석체크 자동화용 서비스 계정`
   - "만들기 및 계속하기" 클릭

3. **역할 선택 (선택사항)**
   - 역할 선택은 건너뛰어도 됨 (스프레드시트 공유로 권한 부여)
   - "계속" → "완료" 클릭

### 2-4. JSON 키 파일 생성 및 다운로드

1. **서비스 계정 목록에서 생성한 계정 클릭**
   - "API 및 서비스" → "사용자 인증 정보" 페이지
   - 방금 생성한 서비스 계정의 이메일 클릭

2. **키 생성**
   - "키" 탭 클릭
   - "키 추가" → "새 키 만들기" 클릭
   - 키 유형: "JSON" 선택
   - "만들기" 클릭

3. **JSON 파일 다운로드**
   - 자동으로 JSON 파일이 다운로드됨
   - 파일 이름 예: `프로젝트명-abc123def456.json`
   - **중요**: 이 파일은 절대 외부에 공개하지 마세요!

### 2-5. 구글 스프레드시트 공유

1. **스프레드시트 열기**
   - 출석 관리할 구글 스프레드시트 열기

2. **서비스 계정에 권한 부여**
   - 스프레드시트 우측 상단 "공유" 버튼 클릭
   - JSON 파일 안의 `client_email` 값을 복사
     - 예: `출석체크봇@프로젝트명.iam.gserviceaccount.com`
   - 해당 이메일을 "편집자" 권한으로 추가
   - "완료" 클릭

3. **스프레드시트 ID 확인**
   - 스프레드시트 URL에서 ID 부분 복사
   - URL 형식: `https://docs.google.com/spreadsheets/d/{스프레드시트ID}/edit`
   - 예: `1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P`

### 2-6. 시트 구조 확인

스프레드시트는 다음과 같은 구조를 가져야 합니다:

| A열(번호) | B열(이름) | ... | H열 | I열 | J열 | K열 | L열 |
|----------|----------|-----|-----|-----|-----|-----|-----|
| 1        | 홍길동    | ... |     |     |     |     |     |
| 2        | 김철수    | ... | O   |     |     |     |     |
| 3        | 이영희    | ... |     |     | O   |     |     |

- **이름 열**: 학생 이름이 있는 열 (기본: B열)
- **시작 행**: 데이터가 시작되는 행 (기본: 2행, 1행은 헤더)
- **출석 열**: H, I, J, K 등 날짜별로 다른 열 사용

---

## 3. 워크스페이스 폴더 생성

### 3-1. 폴더 구조

```
Slack_auto_attendance_check/
└── workspaces/
    ├── 테스트/
    │   ├── workspace.json           # 워크스페이스 설정
    │   └── credentials.json         # 구글 서비스 계정 키
    ├── 서울대/
    │   ├── workspace.json
    │   └── credentials.json
    ├── 연세대/
    │   ├── workspace.json
    │   └── credentials.json
    └── 고려대/
        ├── workspace.json
        └── credentials.json
```

### 3-2. workspace.json 작성

각 워크스페이스 폴더에 `workspace.json` 파일을 생성합니다:

```json
{
  "display_name": "서울대학교",
  "slack_bot_token": "xoxb-여기에-슬랙-봇-토큰-입력",
  "slack_channel_id": "C01ABC123DEF",
  "spreadsheet_id": "1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P",
  "sheet_name": "Sheet1",
  "name_column": "B",
  "start_row": 2
}
```

**각 필드 설명:**
- `display_name`: 웹 UI에 표시될 이름
- `slack_bot_token`: 1-3단계에서 복사한 Bot Token
- `slack_channel_id`: 1-4단계에서 확인한 채널 ID
- `spreadsheet_id`: 2-5단계에서 확인한 스프레드시트 ID
- `sheet_name`: 시트 이름 (기본: "Sheet1")
- `name_column`: 학생 이름이 있는 열 (예: "B")
- `start_row`: 학생 데이터가 시작되는 행 번호 (예: 2)

### 3-3. credentials.json 복사

2-4단계에서 다운로드한 JSON 파일을:
- 워크스페이스 폴더로 복사
- 파일 이름을 `credentials.json`으로 변경

**예시:**
```
workspaces/서울대/credentials.json
```

---

## 4. 스케줄 설정

### 4-1. config/schedules.json 편집

자동 출석체크 스케줄을 설정합니다:

```json
[
  {
    "name": "서울대 토요일 출석",
    "workspace": "서울대",
    "day_of_week": "sat",
    "hour": 18,
    "minute": 0,
    "column": "K",
    "mark_absent": true,
    "send_notifications": true,
    "enabled": true
  },
  {
    "name": "연세대 일요일 출석",
    "workspace": "연세대",
    "day_of_week": "sun",
    "hour": 20,
    "minute": 30,
    "column": "H",
    "mark_absent": true,
    "send_notifications": true,
    "enabled": true
  }
]
```

**필드 설명:**
- `name`: 스케줄 이름 (로그에 표시됨)
- `workspace`: 워크스페이스 폴더 이름
- `day_of_week`: 요일 (`mon`, `tue`, `wed`, `thu`, `fri`, `sat`, `sun`)
- `hour`: 실행 시간 (0-23)
- `minute`: 실행 분 (0-59)
- `column`: 출석 체크할 열 (예: "K")
- `mark_absent`: 미출석자 자동 X 표시 여부 (`true`/`false`)
- `send_notifications`: 알림 전송 여부 (`true`/`false`)
- `enabled`: 스케줄 활성화 여부 (`true`/`false`)

---

## 5. 서버 실행

### 5-1. 서버 시작

```bash
# Conda 환경 활성화
conda activate auto

# 서버 실행
python server.py
```

### 5-2. 웹 관리 페이지 접속

브라우저에서 다음 주소로 접속:
```
http://localhost:5000
```

### 5-3. 서버 종료

터미널에서 `Ctrl + C` 입력

---

## 6. 테스트

### 6-1. 수동 테스트

웹 UI에서 수동으로 출석체크를 실행하여 정상 작동 확인:

1. 워크스페이스 선택
2. 출석 열 입력 (예: K)
3. "출석체크 시작" 버튼 클릭
4. 결과 확인

### 6-2. 스케줄 테스트

1. `config/schedules.json`에서 테스트용 스케줄 추가
2. 가까운 시간으로 설정 (예: 현재 시간 + 2분)
3. 서버 재시작
4. 로그 확인:
   ```bash
   tail -f logs/scheduler.log
   ```

---

## 7. 트러블슈팅

### 7-1. 슬랙 연결 실패

**증상**: "슬랙 연결 실패" 오류

**해결 방법:**
1. Bot Token이 올바른지 확인 (`xoxb-`로 시작)
2. 채널 ID가 올바른지 확인 (`C`로 시작)
3. 봇이 채널에 추가되었는지 확인
4. Bot Token Scopes 확인

### 7-2. 구글 시트 연결 실패

**증상**: "구글 시트 연결 실패" 오류

**해결 방법:**
1. `credentials.json` 파일이 올바른 위치에 있는지 확인
2. 스프레드시트 ID가 올바른지 확인
3. 서비스 계정 이메일에 스프레드시트 공유되었는지 확인
4. Google Sheets API가 활성화되었는지 확인

### 7-3. 출석 스레드를 찾을 수 없음

**증상**: "출석 스레드를 찾을 수 없습니다" 경고

**해결 방법:**
1. 채널에 "출석" 키워드가 포함된 메시지가 있는지 확인
2. 봇이 메시지 히스토리 읽기 권한이 있는지 확인 (`channels:history`)
3. 최근 메시지인지 확인 (기본적으로 최근 100개 메시지만 검색)

### 7-4. 이름 매칭 실패

**증상**: 출석 댓글의 이름이 스프레드시트에서 찾을 수 없음

**해결 방법:**
1. 스프레드시트의 이름 철자 확인
2. 슬랙 댓글의 이름 형식 확인 ("이름/출석" 또는 "이름 출석")
3. 공백이나 특수문자 확인

---

## 8. 보안 주의사항

### 절대 공개하면 안 되는 파일:
- `credentials.json` (구글 서비스 계정 키)
- `workspace.json` (슬랙 Bot Token 포함)
- `.env` 파일 (환경변수)

### .gitignore에 추가:
```
workspaces/*/credentials.json
workspaces/*/workspace.json
config/schedules.json
logs/
*.log
```

---

## 9. 요약 체크리스트

새 워크스페이스 추가 시 확인사항:

- [ ] 슬랙 앱 생성 및 Bot Token 발급
- [ ] Bot Token Scopes 설정 (6개 권한)
- [ ] 워크스페이스에 앱 설치
- [ ] 채널에 봇 추가 및 채널 ID 확인
- [ ] Google Cloud 프로젝트 생성
- [ ] Google Sheets API 활성화
- [ ] 서비스 계정 생성 및 JSON 키 다운로드
- [ ] 스프레드시트에 서비스 계정 공유 (편집자 권한)
- [ ] 스프레드시트 ID 확인
- [ ] `workspaces/[학교명]/` 폴더 생성
- [ ] `workspace.json` 파일 작성
- [ ] `credentials.json` 파일 복사
- [ ] `config/schedules.json`에 스케줄 추가
- [ ] 수동 테스트 실행
- [ ] 스케줄 테스트 실행

---

문제가 발생하면 `logs/server.log` 또는 `logs/scheduler.log` 파일을 확인하세요!
